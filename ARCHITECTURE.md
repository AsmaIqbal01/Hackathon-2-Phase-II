# System Architecture â€“ Phase II

## Overview

This document describes the system architecture for Phase II of the **Evolution of Todo** project, which transforms a console-based Todo application into a modern, multi-user, full-stack web application.

---

## Table of Contents

- [Architecture Principles](#architecture-principles)
- [System Architecture](#system-architecture)
- [Frontend Architecture](#frontend-architecture)
- [Backend Architecture](#backend-architecture)
- [Database Architecture](#database-architecture)
- [API Design](#api-design)
- [Data Flow](#data-flow)
- [Security Architecture](#security-architecture)
- [Deployment Architecture](#deployment-architecture)
- [Scalability Considerations](#scalability-considerations)

---

## Architecture Principles

### 1. Decoupled Frontend and Backend

**Principle**: Frontend and backend are completely independent systems communicating via REST API.

**Benefits**:
- Independent scaling (scale frontend and backend separately)
- Independent deployment (deploy frontend and backend independently)
- Technology flexibility (can replace frontend or backend without affecting the other)
- Clear separation of concerns (UI logic vs business logic)

**Implementation**:
- Frontend: Next.js application hosted on Vercel
- Backend: FastAPI application hosted on Railway/Render
- Communication: REST API over HTTPS

### 2. API-First Design

**Principle**: Backend exposes all functionality via RESTful API endpoints. Frontend NEVER accesses database directly.

**Benefits**:
- Clear contract between frontend and backend
- Backend can serve multiple clients (web, mobile, CLI)
- API documentation serves as specification
- Easier testing (test API endpoints independently)

**Implementation**:
- OpenAPI/Swagger documentation auto-generated by FastAPI
- All business logic in backend services
- Frontend makes API calls with JWT authentication

### 3. Stateless Backend

**Principle**: Backend stores NO session state. All authentication is stateless using JWT tokens.

**Benefits**:
- Horizontal scaling (any backend instance can serve any request)
- No session storage overhead (no Redis, no database sessions)
- Simplified deployment (no sticky sessions required)
- Better fault tolerance (no state lost if instance crashes)

**Implementation**:
- JWT tokens carry user identity
- No server-side session storage
- Each request is self-contained

### 4. User-Scoped Data

**Principle**: Every database query MUST be scoped to the authenticated user's `user_id`. No cross-user data access.

**Benefits**:
- Data isolation (users can only see their own data)
- Security by default (authorization enforced at query level)
- Privacy compliance (GDPR, CCPA)
- Multi-tenancy support (multiple users in single database)

**Implementation**:
- All queries include `WHERE user_id = <authenticated_user_id>`
- Backend extracts `user_id` from verified JWT
- 403 Forbidden for cross-user access attempts

### 5. Security at Backend

**Principle**: Backend enforces ALL authorization rules. Frontend UI is NOT a security boundary.

**Benefits**:
- Security cannot be bypassed (client-side checks can be manipulated)
- Single source of truth for permissions
- Consistent security across all clients (web, mobile, API)

**Implementation**:
- JWT verification on every protected endpoint
- User ownership checks in service layer
- Input validation with Pydantic models
- SQL injection prevention with parameterized queries

---

## System Architecture

### Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Internet                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ HTTPS
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                               â”‚
           â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend (Vercel)  â”‚        â”‚ Backend (Railway)    â”‚
â”‚                      â”‚        â”‚                      â”‚
â”‚  â€¢ Next.js 16+       â”‚        â”‚  â€¢ FastAPI           â”‚
â”‚  â€¢ App Router        â”‚        â”‚  â€¢ SQLModel ORM      â”‚
â”‚  â€¢ Better Auth       â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚  â€¢ JWT Verification  â”‚
â”‚  â€¢ Tailwind CSS      â”‚  API   â”‚  â€¢ Pydantic          â”‚
â”‚  â€¢ TypeScript        â”‚  JSON  â”‚  â€¢ Python 3.12+      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â”‚ SQL
                                           â”‚
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  Neon PostgreSQL     â”‚
                                â”‚                      â”‚
                                â”‚  â€¢ users table       â”‚
                                â”‚  â€¢ tasks table       â”‚
                                â”‚  â€¢ Indexes           â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚User  â”‚                  â”‚Front â”‚                  â”‚Back  â”‚
â”‚      â”‚                  â”‚end   â”‚                  â”‚end   â”‚
â””â”€â”€â”€â”¬â”€â”€â”˜                  â””â”€â”€â”€â”¬â”€â”€â”˜                  â””â”€â”€â”€â”¬â”€â”€â”˜
    â”‚                         â”‚                         â”‚
    â”‚ 1. Click "Add Task"     â”‚                         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
    â”‚                         â”‚ 2. Collect form data    â”‚
    â”‚                         â”‚    Validate client-side â”‚
    â”‚                         â”‚                         â”‚
    â”‚                         â”‚ 3. POST /api/tasks      â”‚
    â”‚                         â”‚    Authorization: Bearer JWT
    â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                         â”‚                         â”‚ 4. Verify JWT
    â”‚                         â”‚                         â”‚ 5. Extract user_id
    â”‚                         â”‚                         â”‚ 6. Validate request (Pydantic)
    â”‚                         â”‚                         â”‚ 7. Create task in DB
    â”‚                         â”‚                         â”‚    (user_id from JWT)
    â”‚                         â”‚                         â”‚
    â”‚                         â”‚ 8. 201 Created          â”‚
    â”‚                         â”‚    {task object}        â”‚
    â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                         â”‚ 9. Update UI            â”‚
    â”‚ 10. See new task        â”‚                         â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
    â”‚                         â”‚                         â”‚
```

---

## Frontend Architecture

### Next.js 16+ App Router

```
frontend/
â”œâ”€â”€ app/                              # App Router directory
â”‚   â”œâ”€â”€ layout.tsx                    # Root layout (wraps all pages)
â”‚   â”œâ”€â”€ page.tsx                      # Home page (/)
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ page.tsx                  # Login page (/login)
â”‚   â”œâ”€â”€ signup/
â”‚   â”‚   â””â”€â”€ page.tsx                  # Signup page (/signup)
â”‚   â””â”€â”€ dashboard/
â”‚       â”œâ”€â”€ layout.tsx                # Dashboard layout
â”‚       â”œâ”€â”€ page.tsx                  # Dashboard page (/dashboard)
â”‚       â””â”€â”€ tasks/
â”‚           â”œâ”€â”€ page.tsx              # Task list (/dashboard/tasks)
â”‚           â””â”€â”€ [id]/
â”‚               â””â”€â”€ page.tsx          # Task detail (/dashboard/tasks/[id])
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/                           # Reusable UI components
â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”œâ”€â”€ Input.tsx
â”‚   â”‚   â”œâ”€â”€ Card.tsx
â”‚   â”‚   â””â”€â”€ Modal.tsx
â”‚   â”œâ”€â”€ tasks/                        # Task-specific components
â”‚   â”‚   â”œâ”€â”€ TaskList.tsx
â”‚   â”‚   â”œâ”€â”€ TaskItem.tsx
â”‚   â”‚   â”œâ”€â”€ TaskForm.tsx
â”‚   â”‚   â””â”€â”€ TaskFilters.tsx
â”‚   â””â”€â”€ auth/                         # Auth-related components
â”‚       â”œâ”€â”€ LoginForm.tsx
â”‚       â”œâ”€â”€ SignupForm.tsx
â”‚       â””â”€â”€ ProtectedRoute.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api-client.ts                 # Centralized API client
â”‚   â”œâ”€â”€ auth.ts                       # Better Auth configuration
â”‚   â””â”€â”€ utils.ts                      # Utility functions
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ task.ts                       # Task TypeScript types
â”‚   â””â”€â”€ user.ts                       # User TypeScript types
â”œâ”€â”€ styles/
â”‚   â””â”€â”€ globals.css                   # Global styles (Tailwind)
â”œâ”€â”€ public/                           # Static assets
â”œâ”€â”€ .env.local.example                # Environment variables template
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ next.config.js
```

### Component Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Root Layout                           â”‚
â”‚  â€¢ Better Auth Provider                                      â”‚
â”‚  â€¢ Global styles                                             â”‚
â”‚  â€¢ Navigation bar                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       â”‚                       â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Home    â”‚      â”‚  Login/Signup  â”‚     â”‚   Dashboard     â”‚
â”‚   Page    â”‚      â”‚     Pages      â”‚     â”‚    (Protected)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚                       â”‚
                                 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  Task List  â”‚      â”‚  Task Detail    â”‚
                                 â”‚  Component  â”‚      â”‚    Component    â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Server Components vs Client Components

**Server Components** (`async`, no 'use client'):
- Pages that fetch data on server
- Layouts
- Static content
- SEO-critical pages

**Client Components** (`'use client'`):
- Interactive forms
- State management (useState, useContext)
- Event handlers (onClick, onChange)
- Hooks (useEffect, useCallback)

```typescript
// Server Component (default)
export default async function TaskListPage() {
  const tasks = await fetchAPI("/api/tasks")  // Runs on server
  return <TaskList tasks={tasks} />
}

// Client Component ('use client')
'use client'
import { useState } from 'react'

export default function TaskForm() {
  const [title, setTitle] = useState('')  // Requires 'use client'

  const handleSubmit = async () => {
    // Handle form submission
  }

  return <form onSubmit={handleSubmit}>...</form>
}
```

### API Client Pattern

```typescript
// lib/api-client.ts
import { authClient } from '@/lib/auth'

export async function fetchAPI(endpoint: string, options?: RequestInit) {
  const session = await authClient.getSession()
  const token = session?.token

  if (!token) {
    throw new Error('Not authenticated')
  }

  const response = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}${endpoint}`,
    {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        ...options?.headers,
      },
    }
  )

  if (!response.ok) {
    throw new Error(`API error: ${response.status}`)
  }

  return response.json()
}
```

---

## Backend Architecture

### FastAPI Project Structure

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py                       # FastAPI app entry point
â”‚   â”œâ”€â”€ config.py                     # Configuration (env vars)
â”‚   â”œâ”€â”€ database.py                   # Database connection & session
â”‚   â”œâ”€â”€ auth/                         # Authentication module
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ jwt_middleware.py         # JWT verification
â”‚   â”‚   â”œâ”€â”€ routes.py                 # /auth/signup, /auth/login
â”‚   â”‚   â”œâ”€â”€ models.py                 # User SQLModel
â”‚   â”‚   â””â”€â”€ schemas.py                # UserSignup, UserLogin Pydantic models
â”‚   â”œâ”€â”€ tasks/                        # Task CRUD module
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ routes.py                 # /api/tasks endpoints
â”‚   â”‚   â”œâ”€â”€ models.py                 # Task SQLModel
â”‚   â”‚   â”œâ”€â”€ schemas.py                # TaskCreate, TaskUpdate Pydantic models
â”‚   â”‚   â””â”€â”€ service.py                # Business logic
â”‚   â””â”€â”€ common/                       # Shared utilities
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ exceptions.py             # Custom exceptions
â”‚       â””â”€â”€ dependencies.py           # Common dependencies
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py                   # Pytest fixtures
â”‚   â”œâ”€â”€ test_auth.py                  # Auth endpoint tests
â”‚   â””â”€â”€ test_tasks.py                 # Task endpoint tests
â”œâ”€â”€ alembic/                          # Database migrations
â”‚   â”œâ”€â”€ versions/                     # Migration scripts
â”‚   â””â”€â”€ env.py
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â”œâ”€â”€ alembic.ini
â””â”€â”€ README.md
```

### Layered Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Routes Layer                      â”‚
â”‚  â€¢ Endpoint definitions                                  â”‚
â”‚  â€¢ Request/response handling                             â”‚
â”‚  â€¢ HTTP status codes                                     â”‚
â”‚  â€¢ Dependency injection                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Middleware Layer                         â”‚
â”‚  â€¢ JWT verification                                      â”‚
â”‚  â€¢ CORS configuration                                    â”‚
â”‚  â€¢ Request logging                                       â”‚
â”‚  â€¢ Error handling                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Service Layer                            â”‚
â”‚  â€¢ Business logic                                        â”‚
â”‚  â€¢ Data validation                                       â”‚
â”‚  â€¢ Transaction management                                â”‚
â”‚  â€¢ Error handling                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ORM Layer                              â”‚
â”‚  â€¢ SQLModel models                                       â”‚
â”‚  â€¢ Database queries                                      â”‚
â”‚  â€¢ Relationships                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Database                              â”‚
â”‚  â€¢ PostgreSQL (Neon)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Example: Task CRUD Flow

```python
# 1. API Route Layer (routes.py)
@router.post("/", response_model=TaskResponse, status_code=201)
async def create_task(
    task_data: TaskCreate,
    user_id: str = Depends(verify_jwt),  # â† JWT verification
    db: Session = Depends(get_db)
):
    """Create a new task for authenticated user."""
    return task_service.create_task(db, user_id, task_data)

# 2. Service Layer (service.py)
class TaskService:
    @staticmethod
    def create_task(db: Session, user_id: str, task_data: TaskCreate) -> Task:
        """Business logic for creating a task."""
        # Validate Phase I business rules
        if not task_data.title or len(task_data.title) < 3:
            raise ValidationError("Title must be at least 3 characters")

        # Create task (user_id from verified JWT, NOT client)
        task = Task(
            **task_data.dict(),
            user_id=user_id  # â† From JWT, not client input
        )

        db.add(task)
        db.commit()
        db.refresh(task)
        return task

# 3. ORM Layer (models.py)
class Task(SQLModel, table=True):
    __tablename__ = "tasks"

    id: UUID = Field(default_factory=uuid4, primary_key=True)
    user_id: UUID = Field(foreign_key="users.id", index=True)  # â† Indexed!
    title: str = Field(max_length=255)
    description: Optional[str] = None
    status: str = Field(default="todo")
    priority: Optional[str] = None
    tags: List[str] = Field(default_factory=list, sa_column=Column(ARRAY(String)))
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
```

---

## Database Architecture

### Entity-Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              users                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           UUID      PK           â”‚
â”‚ email        VARCHAR   UNIQUE       â”‚
â”‚ hashed_pwd   VARCHAR                â”‚
â”‚ created_at   TIMESTAMP              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ 1:N
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              tasks                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           UUID      PK           â”‚
â”‚ user_id      UUID      FK â†’ users   â”‚â—„â”€â”€â”€ INDEX
â”‚ title        VARCHAR   NOT NULL     â”‚
â”‚ description  TEXT                   â”‚
â”‚ status       VARCHAR   NOT NULL     â”‚
â”‚ priority     VARCHAR                â”‚
â”‚ tags         TEXT[]                 â”‚
â”‚ created_at   TIMESTAMP              â”‚
â”‚ updated_at   TIMESTAMP              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SQL Schema

```sql
-- Users table
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tasks table
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(50) NOT NULL DEFAULT 'todo',
    priority VARCHAR(50),
    tags TEXT[],
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_users_email ON users(email);
```

### Data Ownership Enforcement

**CRITICAL**: Every task query MUST include `WHERE user_id = <authenticated_user_id>`:

```python
# âœ… CORRECT: User-scoped query
tasks = db.query(Task).filter(Task.user_id == user_id).all()

# âŒ VIOLATION: Returns ALL users' tasks!
tasks = db.query(Task).all()
```

---

## API Design

### RESTful API Endpoints

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| POST | `/auth/signup` | Register new user | No |
| POST | `/auth/login` | Authenticate user | No |
| GET | `/api/tasks` | List user's tasks | Yes |
| POST | `/api/tasks` | Create new task | Yes |
| GET | `/api/tasks/{id}` | Get task by ID | Yes |
| PATCH | `/api/tasks/{id}` | Update task | Yes |
| DELETE | `/api/tasks/{id}` | Delete task | Yes |

### Request/Response Examples

#### Create Task

**Request:**
```http
POST /api/tasks
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "title": "Complete authentication",
  "description": "Implement JWT-based auth",
  "status": "in-progress",
  "priority": "high",
  "tags": ["phase-ii", "security"]
}
```

**Response (201 Created):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "title": "Complete authentication",
  "description": "Implement JWT-based auth",
  "status": "in-progress",
  "priority": "high",
  "tags": ["phase-ii", "security"],
  "created_at": "2026-01-09T10:30:00Z",
  "updated_at": "2026-01-09T10:30:00Z"
}
```

#### Error Response

**Response (401 Unauthorized):**
```json
{
  "error": {
    "code": 401,
    "message": "Token expired"
  }
}
```

**Response (403 Forbidden):**
```json
{
  "error": {
    "code": 403,
    "message": "Access denied: task not found or not owned by user"
  }
}
```

---

## Security Architecture

### Defense in Depth

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Layer 1: Network Security                    â”‚
â”‚  â€¢ HTTPS only (TLS 1.3)                                  â”‚
â”‚  â€¢ HSTS headers                                          â”‚
â”‚  â€¢ CORS configuration                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Layer 2: Authentication                         â”‚
â”‚  â€¢ JWT verification                                      â”‚
â”‚  â€¢ Token expiration                                      â”‚
â”‚  â€¢ Password hashing (bcrypt)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Layer 3: Authorization                          â”‚
â”‚  â€¢ User-scoped queries                                   â”‚
â”‚  â€¢ Ownership checks                                      â”‚
â”‚  â€¢ 403 for cross-user access                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Layer 4: Input Validation                       â”‚
â”‚  â€¢ Pydantic models                                       â”‚
â”‚  â€¢ Type checking                                         â”‚
â”‚  â€¢ Constraint validation                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Layer 5: Data Protection                        â”‚
â”‚  â€¢ Parameterized queries (SQL injection prevention)      â”‚
â”‚  â€¢ Encrypted connections to database                     â”‚
â”‚  â€¢ User data isolation                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployment Architecture

### Production Deployment

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CloudFlare CDN  â”‚
                    â”‚   (DNS, DDoS)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Vercel (Frontend)â”‚        â”‚ Railway (Backend) â”‚
    â”‚  â€¢ Next.js App    â”‚        â”‚  â€¢ FastAPI App    â”‚
    â”‚  â€¢ Auto-scaling   â”‚        â”‚  â€¢ Auto-scaling   â”‚
    â”‚  â€¢ CDN caching    â”‚        â”‚  â€¢ Health checks  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ Neon PostgreSQL     â”‚
                                 â”‚ â€¢ Auto-scaling      â”‚
                                 â”‚ â€¢ Automatic backups â”‚
                                 â”‚ â€¢ Connection poolingâ”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Scalability Considerations

### Horizontal Scaling

- **Frontend**: Vercel auto-scales based on traffic
- **Backend**: Railway/Render can scale to multiple instances
- **Database**: Neon provides serverless auto-scaling

### Performance Optimizations

1. **Database Indexes**: user_id, status, created_at
2. **API Caching**: Cache frequently accessed data (optional)
3. **Connection Pooling**: Neon built-in connection pooling
4. **CDN**: Static assets served from CDN (Vercel Edge Network)

---

**Architecture is never final. Continuously evaluate and evolve based on requirements.** ğŸ—ï¸
